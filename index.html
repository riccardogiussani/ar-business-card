<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Webpage</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f0f8ff;
        }

        #homepage {
            padding-top: 50px;
        }

        #ar-mode {
            display: none;
            position: fixed;
            inset: 0;
            background: black;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        button {
            background-color: #007bff;
            color: white;
            font-size: 18px;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
        }

        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #d6d6d6; cursor: not-allowed; }

        #exit-ar-btn {
            position: absolute;
            bottom: 20px;
            background-color: red;
        }

        #exit-ar-btn:hover { background-color: #8f1f1f; }
    </style>
</head>
<body>
    <div id="ar-mode">
        <button id="exit-ar-btn" onclick="exitARSession()">Go Back</button>
    </div>

    <div id="homepage">
        <h1>Welcome to My AR Webpage</h1>
        <p id="ar-support-status">Checking AR support...</p>
        <button id="ar-btn" onclick="startARSession()">Start AR Session</button>
    </div>

    <script>
        let xrSession = null;

        async function startARSession() {
            const homepage = document.getElementById("homepage");
            const arMode = document.getElementById("ar-mode");

            if (!navigator.xr) {
                alert("WebXR not supported.");
                return;
            }

            try {
                const supported = await navigator.xr.isSessionSupported('immersive-ar');
                if (!supported) throw "AR not supported on this device.";

                homepage.style.display = "none";
                arMode.style.display = "flex";

                xrSession = await navigator.xr.requestSession('immersive-ar');
                xrSession.addEventListener('end', exitARSession);

                const gl = createWebGLContext();
                xrSession.updateRenderState({ baseLayer: new XRWebGLLayer(xrSession, gl) });

                const refSpace = await xrSession.requestReferenceSpace('local');
                xrSession.requestAnimationFrame((t, frame) => onXRFrame(frame, refSpace, gl));
            } catch (err) {
                alert(err);
                exitARSession();
            }
        }

        function createWebGLContext() {
            const canvas = document.createElement('canvas');
            document.getElementById("ar-mode").appendChild(canvas);

            const gl = canvas.getContext('webgl', {xrCompatible: true}); // ✅ Ensure XR compatibility
            if (!gl) {
                alert("WebGL not supported.");
                exitARSession();
                return null;
            }
            return gl;
        }


        function onXRFrame(frame, refSpace, gl) {
            const session = frame.session;
            const pose = frame.getViewerPose(refSpace);
            if (pose) {
                gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
                session.requestAnimationFrame((t, newFrame) => onXRFrame(newFrame, refSpace, gl));
            }
        }

        function exitARSession() {
            if (xrSession) {
                xrSession.end();
                xrSession = null;
            }

            // Ensure homepage is visible and AR mode is hidden
            document.getElementById("homepage").style.display = "block";
            document.getElementById("ar-mode").style.display = "none";
        }


        (async function checkWebXRSupport() {
            const arStatus = document.getElementById("ar-support-status");
            const arBtn = document.getElementById("ar-btn");

            if (!navigator.xr) {
                arStatus.textContent = '❌ WebXR is not supported.';
                arBtn.disabled = true;
                return;
            }

            try {
                const supported = await navigator.xr.isSessionSupported('immersive-ar');
                arStatus.textContent = supported ? '✅ AR is supported!' : '❌ AR not supported.';
                arBtn.disabled = !supported;
            } catch {
                arStatus.textContent = '❌ AR support check failed.';
                arBtn.disabled = true;
            }
        })();

        exitARSession();
    </script>
</body>
</html>