<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Webpage</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f0f8ff;
        }

        #homepage {
            padding-top: 50px;
        }

        #ar-mode {
            display: none;
            position: fixed;
            inset: 0;
            background: black;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        button {
            background-color: #007bff;
            color: white;
            font-size: 18px;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
        }

        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #d6d6d6; cursor: not-allowed; }

        #exit-ar-btn {
            position: absolute;
            bottom: 20px;
            background-color: red;
            z-index: 1000;
        }

        #exit-ar-btn:hover { background-color: #8f1f1f; }
    </style>
</head>
<body>
    <div id="ar-mode">
        <button id="exit-ar-btn" onclick="exitARSession()">Go Back</button>
    </div>

    <div id="homepage">
        <h1>Welcome to My AR Webpage</h1>
        <p id="ar-support-status">Checking AR support...</p>
        <button id="ar-btn" onclick="startARSession()">Start AR Session</button>
    </div>

    <script>
        let xrSession = null;

        async function startARSession() {
            document.getElementById("homepage").style.display = "none";
            document.getElementById("ar-mode").style.display = "flex";

            if (navigator.xr) {
                try {
                    const supported = await navigator.xr.isSessionSupported('immersive-ar');
                    if (!supported) throw new Error("AR is not supported");

                    xrSession = await navigator.xr.requestSession('immersive-ar');
                    const gl = createWebGLContext();

                    xrSession.updateRenderState({
                        baseLayer: new XRWebGLLayer(xrSession, gl) // ✅ Ensure correct rendering
                    });

                    xrSession.requestReferenceSpace('local').then((referenceSpace) => {
                        function onXRFrame(t, frame) {
                            const session = frame.session;
                            const pose = frame.getViewerPose(referenceSpace);
                            if (pose) {
                                gl.clearColor(0.0, 0.0, 0.0, 1.0);
                                gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
                                session.requestAnimationFrame(onXRFrame);
                            }
                        }
                        session.requestAnimationFrame(onXRFrame);
                    });

                    xrSession.addEventListener('end', exitARSession);
                } catch (err) {
                    console.error("Error starting AR session:", err);
                    alert(err);
                    exitARSession();
                }
            } else {
                alert("WebXR is not supported.");
                exitARSession();
            }
        }


        function createWebGLContext() {
            const canvas = document.createElement('canvas');
            canvas.style.position = "absolute";
            canvas.style.top = "0";
            canvas.style.left = "0";
            canvas.style.width = "100vw";
            canvas.style.height = "100vh";

            const gl = canvas.getContext('webgl', { xrCompatible: true });
            if (!gl) {
                alert("WebGL not supported.");
                exitARSession();
                return null;
            }

            document.getElementById("ar-mode").appendChild(canvas); // Append to AR mode
            return gl;
        }


        function onXRFrame(frame, refSpace, gl) {
            const session = frame.session;
            const pose = frame.getViewerPose(refSpace);
            if (pose) {
                gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
                session.requestAnimationFrame((t, newFrame) => onXRFrame(newFrame, refSpace, gl));
            }
        }

        function exitARSession() {
            if (xrSession) {
                xrSession.end();
                xrSession = null;
            }

            // Ensure homepage is visible and AR mode is hidden
            document.getElementById("homepage").style.display = "block";
            document.getElementById("ar-mode").style.display = "none";
        }


        (async function checkWebXRSupport() {
            const arStatus = document.getElementById("ar-support-status");
            const arBtn = document.getElementById("ar-btn");

            if (!navigator.xr) {
                arStatus.textContent = '❌ WebXR is not supported.';
                arBtn.disabled = true;
                return;
            }

            try {
                const supported = await navigator.xr.isSessionSupported('immersive-ar');
                arStatus.textContent = supported ? '✅ AR is supported!' : '❌ AR not supported.';
                arBtn.disabled = !supported;
            } catch {
                arStatus.textContent = '❌ AR support check failed.';
                arBtn.disabled = true;
            }
        })();

        exitARSession();
    </script>
</body>
</html>